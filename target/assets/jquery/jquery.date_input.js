DateInput=function(e){function t(n,r){if(typeof r!="object")r={};e.extend(this,t.DEFAULT_OPTS,r);this.input=e(n);this.bindMethodsToObj("show","hide","hideIfClickOutside","keydownHandler","selectDate");this.build();this.selectDate();this.hide()}t.DEFAULT_OPTS={month_names:["January","February","March","April","May","June","July","August","September","October","November","December"],short_month_names:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],short_day_names:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],start_of_week:1};t.prototype={build:function(){var t=e('<p class="month_nav">'+'<span class="button prev" title="[Page-Up]">&#171;</span>'+' <span class="month_name"></span> '+'<span class="button next" title="[Page-Down]">&#187;</span>'+"</p>");this.monthNameSpan=e(".month_name",t);e(".prev",t).click(this.bindToObj(function(){this.moveMonthBy(-1)}));e(".next",t).click(this.bindToObj(function(){this.moveMonthBy(1)}));var n=e('<p class="year_nav">'+'<span class="button prev" title="[Ctrl+Page-Up]">&#171;</span>'+' <span class="year_name"></span> '+'<span class="button next" title="[Ctrl+Page-Down]">&#187;</span>'+"</p>");this.yearNameSpan=e(".year_name",n);e(".prev",n).click(this.bindToObj(function(){this.moveMonthBy(-12)}));e(".next",n).click(this.bindToObj(function(){this.moveMonthBy(12)}));var r=e('<div class="nav"></div>').append(t,n);var i="<table><thead><tr>";e(this.adjustDays(this.short_day_names)).each(function(){i+="<th>"+this+"</th>"});i+="</tr></thead><tbody></tbody></table>";this.dateSelector=this.rootLayers=e('<div class="date_selector"></div>').append(r,i).insertAfter(this.input);if(e.browser.msie&&e.browser.version<7){this.ieframe=e('<iframe class="date_selector_ieframe" frameborder="0" src="#"></iframe>').insertBefore(this.dateSelector);this.rootLayers=this.rootLayers.add(this.ieframe);e(".button",r).mouseover(function(){e(this).addClass("hover")});e(".button",r).mouseout(function(){e(this).removeClass("hover")})}this.tbody=e("tbody",this.dateSelector);this.input.change(this.bindToObj(function(){this.selectDate()}));this.selectDate()},selectMonth:function(t){var n=new Date(t.getFullYear(),t.getMonth(),1);if(!this.currentMonth||!(this.currentMonth.getFullYear()==n.getFullYear()&&this.currentMonth.getMonth()==n.getMonth())){this.currentMonth=n;var r=this.rangeStart(t),i=this.rangeEnd(t);var s=this.daysBetween(r,i);var o="";for(var u=0;u<=s;u++){var a=new Date(r.getFullYear(),r.getMonth(),r.getDate()+u,12,0);if(this.isFirstDayOfWeek(a))o+="<tr>";if(a.getMonth()==t.getMonth()){o+='<td class="selectable_day" date="'+this.dateToString(a)+'">'+a.getDate()+"</td>"}else{o+='<td class="unselected_month" date="'+this.dateToString(a)+'">'+a.getDate()+"</td>"}if(this.isLastDayOfWeek(a))o+="</tr>"}this.tbody.empty().append(o);this.monthNameSpan.empty().append(this.monthName(t));this.yearNameSpan.empty().append(this.currentMonth.getFullYear());e(".selectable_day",this.tbody).click(this.bindToObj(function(t){this.changeInput(e(t.target).attr("date"))}));e("td[date="+this.dateToString(new Date)+"]",this.tbody).addClass("today");e("td.selectable_day",this.tbody).mouseover(function(){e(this).addClass("hover")});e("td.selectable_day",this.tbody).mouseout(function(){e(this).removeClass("hover")})}e(".selected",this.tbody).removeClass("selected");e("td[date="+this.selectedDateString+"]",this.tbody).addClass("selected")},selectDate:function(e){if(typeof e=="undefined"){e=this.stringToDate(this.input.val())}if(!e)e=new Date;this.selectedDate=e;this.selectedDateString=this.dateToString(this.selectedDate);this.selectMonth(this.selectedDate)},changeInput:function(e){this.input.val(e).change();this.hide()},show:function(){this.rootLayers.css("display","block");e([window,document.body]).click(this.hideIfClickOutside);this.input.unbind("focus",this.show);e(document.body).keydown(this.keydownHandler);this.setPosition()},hide:function(){this.rootLayers.css("display","none");e([window,document.body]).unbind("click",this.hideIfClickOutside);this.input.focus(this.show);e(document.body).unbind("keydown",this.keydownHandler)},hideIfClickOutside:function(e){if(e.target!=this.input[0]&&!this.insideSelector(e)){this.hide()}},insideSelector:function(e){var t=this.dateSelector.position();t.right=t.left+this.dateSelector.outerWidth();t.bottom=t.top+this.dateSelector.outerHeight();return e.pageY<t.bottom&&e.pageY>t.top&&e.pageX<t.right&&e.pageX>t.left},keydownHandler:function(e){switch(e.keyCode){case 9:case 27:this.hide();return;break;case 13:this.changeInput(this.selectedDateString);break;case 33:this.moveDateMonthBy(e.ctrlKey?-12:-1);break;case 34:this.moveDateMonthBy(e.ctrlKey?12:1);break;case 38:this.moveDateBy(-7);break;case 40:this.moveDateBy(7);break;case 37:this.moveDateBy(-1);break;case 39:this.moveDateBy(1);break;default:return}e.preventDefault()},stringToDate:function(e){var t;if(t=e.match(/^(\d{1,2}) ([^\s]+) (\d{4,4})$/)){return new Date(t[3],this.shortMonthNum(t[2]),t[1],12,0)}else{return null}},dateToString:function(e){return e.getDate()+" "+this.short_month_names[e.getMonth()]+" "+e.getFullYear()},setPosition:function(){var e=this.input.offset();this.rootLayers.css({top:e.top+this.input.outerHeight(),left:e.left});if(this.ieframe){this.ieframe.css({width:this.dateSelector.outerWidth(),height:this.dateSelector.outerHeight()})}},moveDateBy:function(e){var t=new Date(this.selectedDate.getFullYear(),this.selectedDate.getMonth(),this.selectedDate.getDate()+e);this.selectDate(t)},moveDateMonthBy:function(e){var t=new Date(this.selectedDate.getFullYear(),this.selectedDate.getMonth()+e,this.selectedDate.getDate());if(t.getMonth()==this.selectedDate.getMonth()+e+1){t.setDate(0)}this.selectDate(t)},moveMonthBy:function(e){var t=new Date(this.currentMonth.getFullYear(),this.currentMonth.getMonth()+e,this.currentMonth.getDate());this.selectMonth(t)},monthName:function(e){return this.month_names[e.getMonth()]},bindToObj:function(e){var t=this;return function(){return e.apply(t,arguments)}},bindMethodsToObj:function(){for(var e=0;e<arguments.length;e++){this[arguments[e]]=this.bindToObj(this[arguments[e]])}},indexFor:function(e,t){for(var n=0;n<e.length;n++){if(t==e[n])return n}},monthNum:function(e){return this.indexFor(this.month_names,e)},shortMonthNum:function(e){return this.indexFor(this.short_month_names,e)},shortDayNum:function(e){return this.indexFor(this.short_day_names,e)},daysBetween:function(e,t){e=Date.UTC(e.getFullYear(),e.getMonth(),e.getDate());t=Date.UTC(t.getFullYear(),t.getMonth(),t.getDate());return(t-e)/864e5},changeDayTo:function(e,t,n){var r=n*(Math.abs(t.getDay()-e-n*7)%7);return new Date(t.getFullYear(),t.getMonth(),t.getDate()+r)},rangeStart:function(e){return this.changeDayTo(this.start_of_week,new Date(e.getFullYear(),e.getMonth()),-1)},rangeEnd:function(e){return this.changeDayTo((this.start_of_week-1)%7,new Date(e.getFullYear(),e.getMonth()+1,0),1)},isFirstDayOfWeek:function(e){return e.getDay()==this.start_of_week},isLastDayOfWeek:function(e){return e.getDay()==(this.start_of_week-1)%7},adjustDays:function(e){var t=[];for(var n=0;n<e.length;n++){t[n]=e[(n+this.start_of_week)%7]}return t}};e.fn.date_input=function(e){return this.each(function(){new t(this,e)})};e.date_input={initialize:function(t){e("input.date_input").date_input(t)}};return t}(jQuery)