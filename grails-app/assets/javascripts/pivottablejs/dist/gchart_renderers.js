// Generated by CoffeeScript 1.7.1

(function() {
  var $, makeGoogleChart;

  $ = jQuery;

  makeGoogleChart = function(chartType, extraOptions) {
    return function(pivotData, opts) {
      var agg, colKey, colKeys, dataArray, dataTable, defaults, groupByTitle, h, hAxisTitle, headers, k, numCharsInHAxis, options, result, row, rowKey, rowKeys, title, v, vAxisTitle, wrapper, _i, _j, _len, _len1;
      defaults = {
        localeStrings: {
          vs: "vs",
          by: "by"
        }
      };
      opts = $.extend(defaults, opts);
      rowKeys = pivotData.getRowKeys();
      if (rowKeys.length === 0) {
        rowKeys.push([]);
      }
      colKeys = pivotData.getColKeys();
      if (colKeys.length === 0) {
        colKeys.push([]);
      }
      headers = (function() {
        var _i, _len, _results;
        _results = [];
        for (_i = 0, _len = rowKeys.length; _i < _len; _i++) {
          h = rowKeys[_i];
          _results.push(h.join("-"));
        }
        return _results;
      })();
      headers.unshift("");
      numCharsInHAxis = 0;
      dataArray = [headers];
      for (_i = 0, _len = colKeys.length; _i < _len; _i++) {
        colKey = colKeys[_i];
        row = [colKey.join("-")];
        numCharsInHAxis += row[0].length;
        for (_j = 0, _len1 = rowKeys.length; _j < _len1; _j++) {
          rowKey = rowKeys[_j];
          agg = pivotData.getAggregator(rowKey, colKey);
          if (agg.value() != null) {
            row.push(agg.value());
          } else {
            row.push(null);
          }
        }
        dataArray.push(row);
      }
      title = vAxisTitle = pivotData.aggregatorName + (pivotData.valAttrs.length ? "(" + (pivotData.valAttrs.join(", ")) + ")" : "");
      hAxisTitle = pivotData.colAttrs.join("-");
      if (hAxisTitle !== "") {
        title += " " + opts.localeStrings.vs + " " + hAxisTitle;
      }
      groupByTitle = pivotData.rowAttrs.join("-");
      if (groupByTitle !== "") {
        title += " " + opts.localeStrings.by + " " + groupByTitle;
      }


        var chartContainerDiv = $("<div id="+pivotData.pivotContainerId+" class='clear'>");
        theBodySurface=$('#'+pivotData.pivotId);
        thecontainer=$('#'+pivotData.pivotContainerId);
        $('#'+pivotData.pivotContainerId).remove();
        if($('#'+pivotData.pivotContainerId).length == 0) {
            theBodySurface.append(chartContainerDiv);
        }

        var chartContainer = document.getElementById(pivotData.pivotContainerId);
        var emptyElement = $("<span>&nbsp;</span>");
        theBodySurface.append(emptyElement);
        result = $("<div  class='resultClass'>");
        var metaData = [];
        metaData[0] = title;
        metaData[1] = groupByTitle;
        metaData[2] = vAxisTitle;
        metaData[3] =pivotData.pivotContainerId;
        var chartResults = getChart(chartType, dataArray, metaData);

        var chart = new Highcharts.Chart(chartResults);

        result.append(emptyElement);
        emptyElement.append(chartContainer);
    //    result.append(emptyElement);// avant emptyElement

        return result;// avant result

    };
  };

  $.pivotUtilities.gchart_renderers = {
    "Line Chart": makeGoogleChart("line"),
    "Bar Chart": makeGoogleChart("column"),
    "Stacked Bar Chart": makeGoogleChart("stackedcolumn", {
      isStacked: true
    }),
    "Area Chart": makeGoogleChart("area", {
      isStacked: true
    }),
      "Pie Chart": makeGoogleChart("pie"),
      "scatter": makeGoogleChart("scatter"),
  //    "bubbles": makeGoogleChart("bubbles"),
      "bar": makeGoogleChart("bar")

  };

}).call(this);
